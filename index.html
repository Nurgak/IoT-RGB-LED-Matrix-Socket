<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Internet-of-Things RGB LED Matrix via Sockets: Internet-of-Things RGB LED Matrix via Sockets</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Internet-of-Things RGB LED Matrix via Sockets<span id="projectnumber">&#160;Branch: refs/heads/dev, commit: d17cd99c050bbf47fc4c2ee82139cdcd7a3f2734</span>
   </div>
   <div id="projectbrief">Animation generation scripts</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Internet-of-Things RGB LED Matrix via Sockets </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_README"></a> <a href="https://github.com/Nurgak/IoT-RGB-LED-Matrix-Socket/actions/workflows/ci.yml"><img src="https://github.com/Nurgak/IoT-RGB-LED-Matrix-Socket/actions/workflows/ci.yml/badge.svg" alt="CI" style="pointer-events: none;" class="inline"/></a> <a href="https://coveralls.io/github/Nurgak/IoT-RGB-LED-Matrix-Socket"><img src="https://coveralls.io/repos/github/Nurgak/IoT-RGB-LED-Matrix-Socket/badge.svg" alt="Coverage Status" style="pointer-events: none;" class="inline"/></a> <a href="https://nurgak.github.io/IoT-RGB-LED-Matrix-Socket/"><img src="https://img.shields.io/badge/Documentation-Doxygen-blue.svg" alt="Documentation: Doxygen" style="pointer-events: none;" class="inline"/></a> [<img src="https://img.shields.io/badge/license-MIT-yellow.svg" alt="License: MIT" style="pointer-events: none;" class="inline"/>](LICENSE) <a href="https://github.com/psf/black"><img src="https://img.shields.io/badge/Code%20style-Black-black.svg" alt="Code style: black" style="pointer-events: none;" class="inline"/></a></p>
<p ><img src="./iot_rgb_led_matrix.jpg" alt="Internet-of-Things RGB LED Matrix" class="inline"/></p>
<p >This project in the continuation of the <a href="https://github.com/Nurgak/IoT-RGB-LED-Matrix">IoT RGB LED Matrix</a>. Socket communication is used, instead of Node-RED/MQTT, for a much faster update rate, allowing to display remotely generated animations. The <a href="https://github.com/adafruit/RGB-matrix-Panel">Adafruit LED Matrix library</a> is used to take advantage of its incredibly optimized display update routine.</p>
<p >The ESP32 acts as the socket server, anything that is recieved from a client is directly read to the screen buffer. Therefore, the data packing must be done on the client side. Having the ESP32 as the server and the Python side the client allows to send data only when needed - when screen needs to be updated with new data.</p>
<p >Because of the way the data is handled in the Adafruit LED Matrix library, only the 3 most significant bits (MSB) are used for the display, allowing <em>only</em> 8 shades per color channel, or 8^3=512 colors. Therefore, when creating animations, one must keep in mind that only the 3 MSB are actually relevant.</p>
<p >All code, animations and options are <a href="https://nurgak.github.io/IoT-RGB-LED-Matrix-Socket/">extensively documented using Doxygen</a>.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Example animations</h1>
<p >Having the client written in Python makes it straight forward to create generated animations using standard libraries and image processing tools, such as Numpy and OpenCV, and link them to various APIs (weather data, mail service...) and display them quickly.</p>
<p >To display an animation on the matrix call the following command </p><pre class="fragment">client/main.py $ANIMATION [OPTIONS] display $HOST_IP
</pre><p> For example </p><pre class="fragment">client/main.py analog_clock.AnalogClock --timezone Asia/Tokyo display 192.168.3.15
</pre> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Animation   </th><th class="markdownTableHeadNone">Preview   </th><th class="markdownTableHeadNone">Command    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Analog clock animation   </td><td class="markdownTableBodyNone"><img src="analog_clock.AnalogClock.gif" alt="" class="inline" title="Analog clock animation"/>      </td><td class="markdownTableBodyNone"><code>analog_clock.AnalogClock -t Asia/Tokyo</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Conway's Game of Life in color   </td><td class="markdownTableBodyNone"><img src="game_of_life.GameOfLifeColor.gif" alt="" class="inline" title="Conway's Game of Life in color"/>      </td><td class="markdownTableBodyNone"><code>game_of_life.GameOfLifeColor</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Conway's Game of Life fast   </td><td class="markdownTableBodyNone"><img src="game_of_life.GameOfLifeFast.gif" alt="" class="inline" title="Conway's Game of Life fast"/>      </td><td class="markdownTableBodyNone"><code>game_of_life.GameOfLifeFast</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Digital data display   </td><td class="markdownTableBodyNone"><img src="digital_data.DigitalData.png" alt="" class="inline" title="Digital data display"/>      </td><td class="markdownTableBodyNone"><code>digital_data.DigitalData -t Asia/Tokyo -c Tokyo -k $OWM_API_KEY</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Generated fire animation   </td><td class="markdownTableBodyNone"><img src="fire.Fire.gif" alt="" class="inline" title="Generated fire animation"/>      </td><td class="markdownTableBodyNone"><code>fire.Fire</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">English word clock   </td><td class="markdownTableBodyNone"><img src="word_clock.English.png" alt="" class="inline" title="English word clock"/>      </td><td class="markdownTableBodyNone"><code>word_clock.English -t Asia/Tokyo</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Japanese word clock   </td><td class="markdownTableBodyNone"><img src="word_clock.Japanese.png" alt="" class="inline" title="Japanese word clock"/>      </td><td class="markdownTableBodyNone"><code>word_clock.Japanese -t Asia/Tokyo</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Growing tree maze generator   </td><td class="markdownTableBodyNone"><img src="rgb.GrowingTree.gif" alt="" class="inline" title="Growing tree maze generator"/>      </td><td class="markdownTableBodyNone"><code>rgb.GrowingTree</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Hilbert curve animation   </td><td class="markdownTableBodyNone"><img src="rgb.HilbertCurve.gif" alt="" class="inline" title="Hilbert curve animation"/>      </td><td class="markdownTableBodyNone"><code>rgb.HilbertCurve</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Mandelbrot fractal animation   </td><td class="markdownTableBodyNone"><img src="rgb.Mandelbrot.gif" alt="" class="inline" title="Mandelbrot fractal animation"/>      </td><td class="markdownTableBodyNone"><code>rgb.Mandelbrot</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Static QR code   </td><td class="markdownTableBodyNone"><img src="qr_code.QRCode.png" alt="" class="inline" title="Static QR code"/>      </td><td class="markdownTableBodyNone"><code>qr_code.QRCode --text "test"</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Generated water drop animation   </td><td class="markdownTableBodyNone"><img src="water.Water.gif" alt="" class="inline" title="Generated water drop animation"/>      </td><td class="markdownTableBodyNone"><code>water.Water</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Generated falling snow animation   </td><td class="markdownTableBodyNone"><img src="snow.Snow.gif" alt="" class="inline" title="Generated falling snow animation"/>      </td><td class="markdownTableBodyNone"><code>snow.Snow</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Matrix rain animation   </td><td class="markdownTableBodyNone"><img src="matrix.Matrix.gif" alt="" class="inline" title="Matrix rain animation"/>      </td><td class="markdownTableBodyNone"><code>matrix.Matrix --text "test"</code>   </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md2"></a>
Hardware</h1>
<p >An ESP32 breakout board was used in this project with a <a href="https://hackaday.io/project/28945-iot-rgb-led-matrix-controller-esp32">custom adapter PCB</a>. Although the adapter is not strictly necessary as the ESP32 breakout can be connected to the RGB LED matrix with some cables just as well.</p>
<h2><a class="anchor" id="autotoc_md3"></a>
Pinout</h2>
<p >The pin assignment is not strict and every pin can be reconfigured to another one, but it is recommended to follow the pinout below so it would work with the unmodified code. The only requirement is to have 13 GPIO available.</p>
<table class="doxtable">
<tr>
<th>Pin </th><th>GPIO </th><th>Reference  </th></tr>
<tr>
<td>OE </td><td>13 </td><td rowspan="13"><img src="esp32_pinout.png" alt="" class="inline"/>  </td></tr>
<tr>
<td>CLK </td><td>14  </td></tr>
<tr>
<td>LAT </td><td>15  </td></tr>
<tr>
<td>CH_A </td><td>26  </td></tr>
<tr>
<td>CH_B </td><td>4  </td></tr>
<tr>
<td>CH_C </td><td>27  </td></tr>
<tr>
<td>CH_D </td><td>2  </td></tr>
<tr>
<td>R1 </td><td>5  </td></tr>
<tr>
<td>G1 </td><td>17  </td></tr>
<tr>
<td>BL1 </td><td>18  </td></tr>
<tr>
<td>R2 </td><td>19  </td></tr>
<tr>
<td>G2 </td><td>16  </td></tr>
<tr>
<td>BL2 </td><td>25  </td></tr>
</table>
<h1><a class="anchor" id="autotoc_md4"></a>
Software</h1>
<h2><a class="anchor" id="autotoc_md5"></a>
Dependencies</h2>
<p >The ESP32 is programmed via Arduino IDE and needs the following libraries</p>
<ul>
<li><a href="https://github.com/adafruit/RGB-matrix-Panel">https://github.com/adafruit/RGB-matrix-Panel</a></li>
<li><a href="https://github.com/adafruit/Adafruit-GFX-Library">https://github.com/adafruit/Adafruit-GFX-Library</a></li>
<li><a href="https://github.com/adafruit/Adafruit_BusIO">https://github.com/adafruit/Adafruit_BusIO</a></li>
<li><a href="https://www.arduino.cc/reference/en/libraries/wifimanager/">https://www.arduino.cc/reference/en/libraries/wifimanager/</a></li>
</ul>
<h2><a class="anchor" id="autotoc_md6"></a>
Firmware</h2>
<p >The ESP32 needs to have its firmware uploaded before it can recieve the data stream from the client (Python script). The client must be on the same network and be provided with the IP of the ESP32.</p>
<p >The firmware upload can be done using <a href="https://docs.espressif.com/projects/arduino-esp32/en/latest/installing.html#installing-using-boards-manager">Arduino IDE together with the ESP32 board definitions</a>.</p>
<p >The board must be configured as follows from the <code>Tools</code> menu in Arduino IDE:</p><ul>
<li>Board: ESP32 Dev Module</li>
<li>CPU Frequency: 240MHz</li>
<li>Flash Frequency: 80MHz</li>
<li>Flash size: 4MB (32Mb)</li>
<li>Partition Scheme: Default 4MB with spiffs</li>
<li>Core Debul Level: None</li>
<li>PSRAM: Disabled</li>
</ul>
<p >The WiFi credentials need to be entered once using the WiFi access point created by the ESP32 (named <code>ESPLEDMATRIX-XXXXXX</code>), from the address <a href="http://192.168.4.1">http://192.168.4.1</a>. Once connected to the local WiFi the access point no longer works.</p>
<p ><img src="./setup.png" alt="WiFi configuration setup page." class="inline"/></p>
<p >Upon a successful connection to the local WiFi network the matrix displays its IP address.</p>
<p >Once the firmware is uploaded the ESP32 can be reprogrammed using over-the-air (OTA) updating by selecting the new port from <code>Tools</code>, the password is the same as the module name (<code>ESPLEDMATRIX-XXXXXX</code>).</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Fonts</h2>
<p >The fonts used in this project are property of their respective creators. As they are free to be redistributed they are also bundeled with this project, but they have their own licenses distinct from this project.</p>
<ul>
<li><a href="https://fontsup.com/font/small-5x3-regular.html">Small 5x3 Regular</a> by <a href="https://fontsup.com/designer/soxhead2000.html">Soxhead2000</a> (<a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA</a>)</li>
<li><a href="https://littlelimit.net/misaki.htm">Misaki Font</a> by <a href="https://littlelimit.net/about.htm">門真 なむ</a> (<a href="https://littlelimit.net/font.htm#license">free software</a>)</li>
</ul>
<h1><a class="anchor" id="autotoc_md8"></a>
Usage</h1>
<h2><a class="anchor" id="autotoc_md9"></a>
Main</h2>
<p >The <code>main.py</code> file, in the <code>client</code> directory, imports all the example animations and allows to configure and launch them. This is the beginning of all execution.</p>
<p >The <code>-h</code> flag displays how to use it. </p><pre class="fragment">client/main.py -h
</pre><p> Some animations have extra arguments, such as the time zone for the clocks. See the usage for specific animations in the examples section.</p>
<h3><a class="anchor" id="autotoc_md10"></a>
Display</h3>
<p >To display the animation on an RGB LED Matrix add the <code>display</code> suffix with the IP of the ESP32. </p><pre class="fragment">client/main.py $ANIMATION display $HOST_IP
</pre><p> The display can have its maximum current limited, by setting the <code>--current</code> argument in Amperes. This will automatically dim the LEDs, before sending the data to the matrix, if the estimated current exceeds the set value. The LED current consumption was measured for each of the 8 intensity levels and each color separately.</p>
<p ><img src="./color_current.png" alt="Current consumption vs. LED color." class="inline"/></p>
<p >To limit the current add the <code>--current</code>, or <code>-c</code>, argument to the call. </p><pre class="fragment">client/main.py $ANIMATION display $HOST_IP -c 1.2
</pre> <h3><a class="anchor" id="autotoc_md11"></a>
Saving</h3>
<p >To save an animation to a file add the <code>save</code> suffix with the number of frames to save. One frame will result in a static <code>png</code>, more will be saved as a <code>gif</code>. The image file name will be <code>$ANIMATION.png/gif</code>. </p><pre class="fragment">client/main.py $ANIMATION save $FRAMES
</pre><p> The saving script acts as a virtual display, decoding the encoded frame as the actual display would. Therefore, as with the real display, only the 3 MSB of the color are relevant.</p>
<h2><a class="anchor" id="autotoc_md12"></a>
Docker</h2>
<p >An effective way to run the client side is to use Docker. This is a prepared and tested environment where all the dependencies are already installed.</p>
<p >The Docker image was specifically prepared to be (also) compatible with <code>arm32v7</code> architecture, so it would run on a SOC such as a Raspberry Pi.</p>
<h3><a class="anchor" id="autotoc_md13"></a>
Build</h3>
<pre class="fragment">docker build -t iot_rgb_led_matrix .
</pre> <h3><a class="anchor" id="autotoc_md14"></a>
Run</h3>
<p >This command will run the <code>AnalogClock</code> animation by default, other parameters are available (check the <code>Dockerfile</code>). </p><pre class="fragment">docker run -it --rm -e HOST_IP=192.168.3.15 iot_rgb_led_matrix
</pre> <h3><a class="anchor" id="autotoc_md15"></a>
Docker compose</h3>
<p >Docker compose allows to configure and run the script, in the Docker container, in the background (<code>-d</code> flag for the detach) as well as make sure the Docker instance restarts upon reboot. See the <code>docker-compose.yml</code> file for details. </p><pre class="fragment">docker-compose up -d
</pre><p> To stop the docker container call the following </p><pre class="fragment">docker-compose down
</pre> <h1><a class="anchor" id="autotoc_md16"></a>
Notes</h1>
<ul>
<li>This project has only been tested with a 32x32 RGB LED matrix panel.</li>
<li>The recommended panel is an official <a href="https://www.adafruit.com/product/607">Adafruit one</a>. Cheaper can be had, but experience has shown major luminosity degradation and burn-in issues with those.</li>
<li>It can happen that the matrix freezes (the client is unable to send new data to the matrix). To prevent the matrix from showing an invalid state the watchdog restarts the ESP if no new data has been recieved for 2 minutes. Depeding on the usage, this behaviour might not be desired and can be disabled.</li>
</ul>
<h1><a class="anchor" id="autotoc_md17"></a>
License</h1>
<p >This project is published under the [MIT license](LICENSE). </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4
</small></address>
</body>
</html>
